<project name="mjc2wsl" default="all">
    <property name="java.encoding" value="utf-8" />
    <taskdef resource="net/sf/antcontrib/antlib.xml"/>
    
    <property name="mjc2wsl.class.dir" value="bin" />
    <property name="mjc2wsl.src.dir" value="src" />
    <property name="mjc2wsl.options" value="" />
    
    <property name="compiler.class.dir" value="compiler-bin" />
    <property name="compiler.src.dir" value="compiler" />

    <property name="samples.main.dir" value="samples" />
    <property name="samples.temp.dir" value="samples-temp" />
    
    <property name="fermat.dir" value="/home/donny/d/donny/fermat3" />

    <description>
        Builder script for mjc2wsl and related tools, runs test
        on given samples.
    </description>
    
    <target name="init">
        <mkdir dir="${mjc2wsl.class.dir}"/>
        <mkdir dir="${compiler.class.dir}"/>
        <mkdir dir="${samples.temp.dir}"/>
        <copy todir="${samples.temp.dir}">
            <fileset dir="${samples.main.dir}">
                <include name="*.mj"/>
            </fileset>
        </copy>
    </target>

    <target name="build" depends="init" description="build the mjv2wsl tool">
        <javac srcdir="${mjc2wsl.src.dir}" destdir="${mjc2wsl.class.dir}" includeAntRuntime='no' />
    </target>

    <target name="mj-build" depends="init" description="build the mj compiler">
        <javac srcdir="${compiler.src.dir}" destdir="${compiler.class.dir}" includeAntRuntime='no' />
    </target>
    
    <target name="mj-compile">
        <echo message="${filename}" />
        <java classpath="${compiler.class.dir}" classname="Compiler">
            <arg value="${filename}" />
        </java>
    </target>
    
    <target name="mj-samples" depends="build" description="run the mj compiler on the samples">
        <foreach param="filename" target="mj-compile">
            <path>
            <fileset dir='${samples.temp.dir}'>
                <include name="*.mj"/>
            </fileset>
            </path>
        </foreach>
    </target>

    <target name="mj-samples1" depends="mj-build">
    <!-- simplistic version when antlib (foreach) is not available -->
        <antcall target="mj-compile">
            <param name="filename" value="samples-temp/sample.mj" />
        </antcall>
        <antcall target="mj-compile">
            <param name="filename" value="samples-temp/sample1.mj" />
        </antcall>
        <antcall target="mj-compile">
            <param name="filename" value="samples-temp/sample0.mj" />
        </antcall>
    </target>
    
    <target name="mjc2wsl">
        <echo message="${filename}" />
        <java classpath="${mjc2wsl.class.dir}" classname="mjc2wsl">
            <arg line="${mjc2wsl.options}" />
            <arg value="${filename}" />
        </java>
    </target>
    
    <target name="mjc2wsl-samples" depends="build">
        <foreach param="filename" target="mjc2wsl">
            <path>
            <fileset dir='${samples.temp.dir}'>
                <include name="*.obj"/>
            </fileset>
            </path>
        </foreach>
    </target>
    
    <target name="mjc2wsl-samples1" depends="build">
    <!-- simplistic version when antlib (foreach) is not available -->
        <antcall target="mjc2wsl">
            <param name="filename" value="samples-temp/sample0.obj" />
        </antcall>
    </target>
    
    <target name="wsl-run" >
        <exec executable="${fermat.dir}/bin/wsl" >
            <env key="PATH" path="${env.PATH}:${fermat.dir}/bin"/>
            <env key="FermaT" path="${fermat.dir}" />
            <env key="SCHEME_LIBRARY_PATH" path="${fermat.dir}/slib/" />
            <env key="SCM_INIT_PATH" path="${fermat.dir}/scm/Init5e5.scm" />
            <arg value="${filename}"/>
        </exec>
    </target>
    
    <target name="wsl-transf" depends="make-transf-ini"
        description="transform (simplify) the wsl files generated by mjc2wsl">
        <antcall target="wsl-run">
            <param name="filename" value="src-wsl/transf-min.wsl" />
        </antcall>
    </target>
    
    <target name="make-transf-ini">
        <fileset dir="${samples.temp.dir}" casesensitive="no" id="generated-wsl-fileset">
                <patternset id="non.test.sources">
                    <include name="**/*.wsl"/>
                    <exclude name="**/*_t.wsl"/>
                </patternset>
        </fileset>
        <pathconvert pathsep="${line.separator}" property="generated-wsl-files" refid="generated-wsl-fileset">
            
        </pathconvert>

        <echo file="transf.ini">${generated-wsl-files}</echo>
    </target>
    
    <target name="all" depends='mj-samples,mjc2wsl-samples' description="build the tools, run them on the samples to check">
    
    </target>
    
    <target name="clean" description="clean up all the generated content">
        <delete includeemptydirs="true">
            <fileset dir=".">
                <include name="${mjc2wsl.class.dir}/*.class"/>
                <include name="${compiler.class.dir}/*.class"/>
                <include name="${samples.temp.dir}/*"/>
            </fileset>
            <dirset dir=".">
                <include name="${mjc2wsl.class.dir}"/>
                <include name="${compiler.class.dir}"/>
                <include name="${samples.temp.dir}"/>
            </dirset>
        </delete>
    </target>
    
    <!-- jedit specific flags; needs to be the first or the last 10 lines
    :noTabs=true:
    -->
</project>